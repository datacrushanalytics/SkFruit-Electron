<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="./sale.css">
  <title></title>

</head>

<body>
  <div id="loader"></div>
  <div class="container">
    <h1 align="center">विक्री </h1>
    <hr>
    <form id="login">

      <div class="bill-date-container">
        <div id="bill-wrapper" class="input-wrapper">
          <label for="bill">बिल नं :</label>
          <input type="text" id="bill" name="number" placeholder="बिल नं." required readonly>
        </div>

        <div id="date-wrapper" class="input-wrapper">
          <label for="date">दिनांक :</label>
          <input type="date" id="date" name="date" required>
        </div>
      </div>


      <div class="dropdown-container">
        <div id="grahk-wrapper" class="input-wrapper">
          <label for="grahk">ग्राहकाचे नाव :</label>
          <select type="root" id="grahk" name="root" onchange="previousbalance()" required></select>
        </div>
        <div id="number-wrapper" class="input-wrapper">
          <label for="number">मोबाइल नं :</label>
          <select type="root" id="number" name="number" onchange="getCust()" required></select>
        </div>
      </div>


      <div class="row-container">
        <div id="Route-wrapper" class="input-wrapper">
          <label for="Route">रूट :</label>
          <select type="root" id="Route" name="root" onchange="setCustomer()" required></select>
          <input type="hidden" id="custid" name="custid">
        </div>

        <div class="button-wrapper">
          <button type="button" id="account-page-button" style="background-color: #18b3a4;" onclick="goToAccountPage(event)">Add Customer</button>
        </div>

        <div class="button-wrapper">
        </div>
        <button style="background-color: #ff355f;" onclick="openPopup()">Ledger</button>
        <div class="popup" id="popup">
          <div class="popup-content">
            <span class="close" onclick="closePopup()">&times;</span>
            <iframe id="popupIframe" frameborder="0" scrolling="auto"></iframe>
          </div>
        </div>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="address">पत्ता :</label>
          <input type="text" id="address" name="address" placeholder="पत्ता" required>
        </div>

        <div class="input-wrapper">
          <label for="sandarbh">संदर्भ :</label>
          <input type="text" id="sandarbh" name="sandarbh" placeholder="संदर्भ">
        </div>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="bta">बटा :</label>
          <select type="root" id="bta" name="bta" onchange="getProducts()"></select>
          <!-- <button onclick="openScanner()">Scan Barcode</button> -->
          &nbsp; &nbsp;
          <!-- <i class="fa-solid fa-scanner-gun" onclick="openScanner()"></i> -->
          <!-- <i class="fa-sharp-duotone fa-solid fa-barcode-scan"></i> -->
          <!-- <i class="fa-sharp-duotone fa-solid fa-scanner-touchscreen"></i> -->
          <i class="fa-sharp-duotone fa-solid fa-barcode scanner-icon" onclick="openScannerModal()"></i>
        </div>
        <div id="scannerModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeScannerModal1()">&times;</span>
            <p>Scan barcode here:</p>
            <input type="text" id="barcodeInput" placeholder="Scan barcode here" oninput="handleBarcodeInput(event)">
          </div>
        </div>

        <div class="input-wrapper">
          <label for="mark">मार्क :</label>
          <input type="text" id="mark" name="mark" placeholder="मार्क">
        </div>

        <div class="input-wrapper">
          <label for="product">Product :</label>
          <select type="root" id="product" name="product" onchange="updateTotal()"></select>
        </div>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="nag" id="nagLabel">नग :</label>
          <input type="text" id="nag" name="nag" placeholder="नग" value="1" onchange="updateTotal()">
          <input type="hidden" id="nag1" name="nag1">
        </div>

        <div class="input-wrapper">
          <label for="kimmat">किंमत :</label>
          <input type="number" id="kimmat" name="kimmat" placeholder="किंमत" onchange="updateTotal()">
        </div>

        <div class="input-wrapper">
          <label for="total">रक्कम :</label>
          <input type="number" id="total" name="total" placeholder="रक्कम" readonly>
        </div>

        <div class="button-wrapper">
          <button type="button" style="background-color: #26a653;" onclick="myFunction()" class="button">ADD</button>
        </div>
      </div>


      <br>
      <table>
        <tr>
          <th>प्रॉडक्ट</th>
          <th>बटा</th>
          <th>मार्क</th>
          <th>नग</th>
          <th>किंमत</th>
          <th>रक्कम</th>
        </tr>

        <!-- Add more rows as needed -->
        <tbody id="tableBody1">
          <!-- Data will be inserted here -->
        </tbody>
      </table>
      <br>
      <br>


      <div class="row-container">
        <label>गेलेले कॅरेट :</label>
        <div class="carat-inputs">
          <div class="input-wrapper">
            <label for="carate100">100 :</label>
            <input type="number" id="carate100" name="carate100" placeholder="100" onchange="carate()">
          </div>
          <div class="input-wrapper">
            <label for="carate150">150 :</label>
            <input type="number" id="carate150" name="carate150" placeholder="150" onchange="carate()">
          </div>
          <div class="input-wrapper">
            <label for="carate250">250 :</label>
            <input type="number" id="carate250" name="carate250" placeholder="250" onchange="carate()">
          </div>
          <div class="input-wrapper">
            <label for="carate350">350 :</label>
            <input type="number" id="carate350" name="carate350" placeholder="350" onchange="carate()">
          </div>
        </div>
      </div>
      <div class="row-container1">
        <label for="totalCarat">एकूण कॅरेट :</label>
        <input type="number" id="total1" name="totalCarat" placeholder="गेलेले कॅरेट रक्कम" readonly>
      </div>


      <div class="row-container1">
        <label for="totalCarat">बिल रक्कम :</label>
        <input type="number" id="bill1" name="number" placeholder="बिल रक्कम" onchange="totalBalance()" readonly>
      </div>
      <div class="row-container1">
        <label for="totalCarat">मागील बाकी :</label>
        <input type="number" id="previousBalance" name="number" placeholder="मागील बाकी" readonly>
      </div>
      <div class="row-container1">
        <label for="totalCarat">एकूण रक्कम :</label>
        <input type="number" id="totalBill" name="number" placeholder="एकूण रक्कम" readonly>
      </div>

      <div class="row-container1">
        <label for="totalCarat">रोख जमा :</label>
        <input type="number" id="bill_cash" name="number" placeholder="रोख जमा" onchange="totalBalance()">
      </div>
      <div class="row-container1">
        <label for="totalCarat">ऑनलाईन जमा बँक :</label>
        <select type="root" id="onlineAcc" name="onlineAcc" onchange="toggleReadonly()">
        </select>
      </div>
      <div class="row-container1">
        <label for="totalCarat">ऑनलाईन जमा :</label>
        <input type="number" id="online" name="number" placeholder="ऑनलाईन जमा" onchange="totalBalance()" readonly>
      </div>
      <div class="row-container1">
        <label for="totalCarat">सूट रक्कम :</label>
        <input type="number" id="discount" name="number" placeholder="सूट रक्कम" onchange="totalBalance()">
      </div>

      <div class="row-container">
        <label>जमा कॅरेट :</label>
        <div class="carat-inputs">
          <div class="input-wrapper">
            <label for="carate100">100 :</label>
            <input type="number" id="carate1100" name="carate100" placeholder="100" onchange="carate1()">
          </div>
          <div class="input-wrapper">
            <label for="carate150">150 :</label>
            <input type="number" id="carate1150" name="carate150" placeholder="150" onchange="carate1()">
          </div>
          <div class="input-wrapper">
            <label for="carate250">250 :</label>
            <input type="number" id="carate1250" name="carate250" placeholder="250" onchange="carate1()">
          </div>
          <div class="input-wrapper">
            <label for="carate350">350 :</label>
            <input type="number" id="carate1350" name="carate350" placeholder="350" onchange="carate1()">
          </div>
        </div>
      </div>
      <div class="row-container1">
        <label for="totalCarat">एकूण जमा कॅरेट :</label>
        <input type="number" id="total2" name="totalCarat" placeholder="जमा कॅरेट रक्कम" readonly>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="note">संदर्भ :</label>
          <input type="text" id="note" name="note" placeholder="संदर्भ">
        </div>

        <div class="input-wrapper">
          <label for="baki">बाकी रक्कम :</label>
          <input type="number" id="baki" name="baki" placeholder="बाकी रक्कम" readonly>
        </div>
      </div>

      <div class="row-container">
        <label>बाकी कॅरेट :</label>
        <div class="carat-inputs">
          <div class="input-wrapper">
            <label for="carate100">100 :</label>
            <input type="number" id="carate2100" name="carate2100" placeholder="100" readonly>
            <input type="hidden" id="carate22100" name="carate22100" placeholder="100" readonly>
          </div>
          <div class="input-wrapper">
            <label for="carate150">150 :</label>
            <input type="number" id="carate2150" name="carate2150" placeholder="150" readonly>
            <input type="hidden" id="carate22150" name="carate22150" placeholder="150" readonly>
          </div>
          <div class="input-wrapper">
            <label for="carate250">250 :</label>
            <input type="number" id="carate2250" name="carate2250" placeholder="250" readonly>
            <input type="hidden" id="carate22250" name="carate22250" placeholder="250" readonly>
          </div>
          <div class="input-wrapper">
            <label for="carate350">350 :</label>
            <input type="number" id="carate2350" name="carate2350" placeholder="350" readonly>
            <input type="hidden" id="carate22350" name="carate22350" placeholder="350" readonly>
          </div>
        </div>
      </div>

      <button type="button" style="background-color: #26a653;" class="save" onclick="insertSale()">Save</button>
      <button type="button" style="background-color: #ff355f;" class="save" onclick="confirmAndProceed()">Back</button>
  </div>
  </form>

</body>
<script src="./sale.js"></script>
<script src="./sale2.js"></script>
<script>

function editRow(button, id) {
    var row = button.parentElement.parentElement;
    var cells = row.querySelectorAll('td');

    // Save current values of quantity and rate
    const originalQuantity = cells[3].textContent;
    const originalRate = cells[4].textContent;

    // Convert quantity and rate cells to input fields with onchange handlers
    cells[3].innerHTML = `<input type="number" value="${originalQuantity}" min="1" style="width: 60px;" onchange="updateRowTotal(this)">`;
    cells[4].innerHTML = `<input type="number" value="${originalRate}" min="0" style="width: 60px;" onchange="updateRowTotal(this)">`;

    // Calculate the initial total and set it in the price cell
    updateRowTotal(cells[3].querySelector('input'));

    // Replace action buttons with "Save" and "Cancel"
    cells[6].innerHTML = `
        <button type="button" onclick="saveRow(this,'${id}')">Save</button>
        <button type="button" onclick="cancelEdit(this, '${originalQuantity}', '${originalRate}')">Cancel</button>
    `;
}
  
  function updateRowTotal(inputElement) {
    var row = inputElement.parentElement.parentElement;
    var cells = row.querySelectorAll('td');

    // Get quantity and rate values from the row's input fields
    var quantity = parseInt(cells[3].querySelector('input').value, 10) || 0;
    var rate = parseInt(cells[4].querySelector('input').value, 10) || 0;

    // Get available inventory from a hidden field (like 'nag1')
    var availableInventory = parseInt(document.getElementById("nag1").value, 10) || 0;

    // Check if quantity exceeds available inventory
    if (quantity > availableInventory) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Inventory Is not available',
        });
        cells[3].querySelector('input').value = 0;  // Reset the quantity
        return; // Exit the function
    }

    // Calculate total as quantity * rate
    var total = quantity * rate;

    // Update the total in the table
    cells[5].textContent = total;

    // Update the hidden total field if needed (to reflect the updated total)
    document.getElementById("total").value = total;
}

function saveRow(button, id1) {
    var row = button.parentElement.parentElement;
    var cells = row.querySelectorAll('td');

    // Get updated values from input fields
    var updatedQuantity = parseInt(cells[3].querySelector('input').value, 10) || 0;
    var updatedRate = parseInt(cells[4].querySelector('input').value, 10) || 0;
    var updatedPrice = updatedQuantity * updatedRate;

    // Update the table cells with new values
    cells[3].innerHTML = updatedQuantity;
    cells[4].innerHTML = updatedRate;
    cells[5].innerHTML = updatedPrice;

    // Restore original action buttons
    cells[6].innerHTML = `
        <button type="button" onclick="deleteUser(this)">Delete</button>
        <button type="button" onclick="editRow(this)">Edit</button>
    `;

    const id = row.getAttribute('data-id');

    // Get the bill_id, bata, mark, and product values for the API request
    const bill_id = document.getElementById('bill').value;  // Assuming the bill ID is available
    const bata = cells[1].textContent;  // Assuming bata is in the second column
    const mark = cells[2].textContent;  // Assuming mark is in the third column
    const product = cells[0].textContent; // Assuming product is in the first column

    // Optional: Make an API call to save the changes
    fetch('http://103.174.102.89:3000/saleproductData/updatesaleproduct', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id: id,  // Unique identifier for the row
            bill_id: bill_id,  // Bill ID
            bata: bata,        // Bata
            mark: mark,        // Mark
            product: product,  // Product
            quantity: updatedQuantity,  // Updated Quantity
            rate: updatedRate,         // Updated Rate
            price: updatedPrice        // Updated Price
        })
    })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            console.log('Update successful:', data);
            Swal.fire({
                icon: 'success',
                title: 'Updated successfully',
                text: 'Product details updated successfully!',
                timer: 2000,
                timerProgressBar: true,
            });
        })
        .catch(error => {
            console.error('Error updating:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Error updating product details.',
            });
        });
}


</script>

</html>