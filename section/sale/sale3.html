<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <title></title>

  <style>

    body {
        font-family: Arial, sans-serif;
        background-color: rgba(242, 242, 242, 0.8);
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    

    .container {
        text-align: center;
        margin-bottom: 20px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 0 20px;
      }

    .table-container {
        max-width: 100%;
        overflow-x: auto;
        margin: 0 auto;
        min-width: 600px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      table {
        width: auto;
        min-width: 100%;
        border-collapse: collapse;
        background-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
      }
      
      th,
      td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 12px;
      }
      
      th {
        background-color: #f2f2f2;
      }

      button {
        background-color:grey; 
        color: white;
        padding: 10px 20px;
        border: none;
        /* border-radius: 5px; */
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      
      button:hover {
        background-color:darkgrey; 
      }

      #bill{
        height: 40px;
        width: 15%;
        /* border-radius: 8px; */
        text-indent:  10px;
        margin-left: 18px;
       
      }
      #date{
        height: 40px;
        width: 15%;
        /* border-radius: 8px; */
        text-indent: 5%;
        margin: 2%;
      }
      
      #number{
        height: 40px;
        width: 15%;
        /* border-radius: 8px; */
        text-indent: 5%;
        margin-left: 10px;
      }

      #grahk, #product, #bta, #Route{
        text-indent: 3%;
        /* border-radius: 6px; */
        height: 40px;
        width: 450px;
        margin-left: 20px;  
      }

      #no, #carate100, #carate150, #carate250, #carate350, #carate1100, #carate1150, #carate1250, #carate1350{
        text-indent: 3%;
        /* border-radius: 6px; */
        height: 40px;
        width: 100px;
        margin-left: 20px;
        
      }

      #mark{
        /* border-radius: 8px; */
        height: 15px;
        width: 50px;     
        padding:  10px;
        margin:20px;
        }

        #nag{
            /* border-radius: 8px; */
            height: 15px;
            width: 50px;           
            padding:  10px;
            margin:20px;
            }
            #address{
                /* border-radius: 8px; */
                height: 15px;
                width: 300px;
                padding:  10px;
                margin:20px;
                  
                }
                #sandarbh, #note{
                  /* border-radius: 8px; */
                  height: 15px;
                  width: 300px;                  
                padding:  10px;
                margin:20px;
                }        

                #bill_cash, #bill1{
                    /* border-radius: 8px; */
                    height: 15px;
                    width: 150px;                    
                    padding:  10px;
                    margin:20px;
                    }

                    #onlineAcc{
                        text-indent: 3%;
                        /* border-radius: 6px; */
                        height: 40px;
                        width: 150px;
                        margin-left: 20px;
                      }

                      #kimmat{
                        /* border-radius: 8px; */
                        height: 15px;
                        width: 100px;                        
                        padding:  10px;                       
                        margin:20px;
                        }
                        
                        #total, #total1, #total2{
                        /* border-radius: 8px; */
                        height: 15px;
                        width: 150px;                         
                        padding:  10px;                     
                        margin:20px;
                        }
                        
                        #baki{
                        /* border-radius: 8px; */
                        height: 25px;
                        width: 150px;                       
                        padding:  10px;                    
                        }

                        #online, #previousBalance{
                            /* border-radius: 8px; */
                            height: 15px;
                            width: 150px;                            
                            padding:  10px;
                            margin:20px;
                            }

                            #discount, #totalBill{
                                /* border-radius: 1px; */
                                height: 15px;
                                padding:  10px;
                                margin:20px;
                                }

  </style>


</head>

<body>
  <div class="container">
    <h1 align="center">विक्री </h1>
    <hr>
<form id="login">
    <div class="first-row">
      <lable for="bill">बिल नं : </lable>
      <input type="text" id="bill" name="number" placeholder="बिल नं.">

      <lable for="date">दिनांक : </lable>
      <input type="text" id="date" name="date" placeholder="दिनांक:">

      <label for="number">मोबाइल नं : </label>
      <select type="root" id="number" name="number" onchange="getCust()">
      </select>
    </div>

    <div>
      <label for="message" aria-placeholder="Root">ग्राहकाचे नाव :</label>
      <select type="root" id="grahk" name="root" onchange="previousbalance()">
        <input type="hidden" id="custid" name="custid">
      </select><br>
      
      <br>
      <label for="message" aria-placeholder="Root">रूट :</label>
      <select type="root" id="Route" name="root">
      </select>
      <br>
    </div>

    <div class="third-row">
      <lable for="address">पत्ता : </lable>
      <input type="text" id="address" name="text" placeholder="पत्ता">

      <label for="sandarbh">संदर्भ :</label>
      <input type="text" id="sandarbh" name="text" placeholder="संदर्भ ">
    </div>


    <div>
      <label for="message" aria-placeholder="Root">बटा :</label>
      <select type="root" id="bta" name="root" onchange="getProducts()">
      </select><br>

      <br>
      <label for="message" aria-placeholder="Root">Product :</label>
      <select type="root" id="product" name="root">
      </select>
    </div>
    <!-- <div>
      <input type="text" id="product" name="text" placeholder="प्रॉडक्ट">
      <input type="text" id="bta" name="text" placeholder="बटा">
    </div> -->
    <lable for="mark">मार्क :</lable>
    <input type="text" id="mark" name="text" placeholder="मार्क">

    <label for="kimmat">किंमत :</label>
    <input type="number" id="kimmat" name="number" placeholder="किंमत">

    <lable for="nag" id="nagLabel">  नग :</lable>
    <input type="text" id="nag" name="text" placeholder="नग" onchange="updateTotal()">

    <label for="total">एकूण रक्कम :</label>
    <input type="number" id="total" name="number" placeholder="एकूण रक्कम">

<br>
<br>

    <div class="fourth-row">
      <!-- <button class="border-hover" >Save</button> -->
      <button type="button" onclick="myFunction()" class="border-hover">ADD</button>
    </div>
    <br>
    <table>
      <tr>
        <th>प्रॉडक्ट</th>
        <th>बटा</th>
        <th>मार्क</th>
        <th>नग</th>
        <th>किंमत</th>
        <th>रक्कम</th>
      </tr>

      <!-- Add more rows as needed -->
      <tbody id="tableBody1">
        <!-- Data will be inserted here -->
      </tbody>
    </table>
<br>
<br>
    <div>
      <!-- <input type="number" id="no1" name="number" placeholder="गेलेले कॅरेट"> -->
      &nbsp;  &nbsp; &nbsp; गेलेले कॅरेट
      <input type="number" id="carate100" name="number" placeholder="100" onchange="carate()">
      <input type="number" id="carate150" name="number" placeholder="150" onchange="carate()">
      <input type="number" id="carate250" name="number" placeholder="250" onchange="carate()">
      <input type="number" id="carate350" name="number" placeholder="350" onchange="carate()">
      <input type="number" id="total1" name="number" placeholder="गेलेले कॅरेट रक्कम">
    </div>

    <div>
      <input type="number" id="bill1" name="number" placeholder="बिल रक्कम" onchange="totalBalance()">
      <input type="number" id="previousBalance" name="number" placeholder="मागील बाकी " readonly>
      <input type="number" id="totalBill" name="number" placeholder="एकूण रक्कम " >
    </div>

    <div>
      <input type="number" id="bill_cash" name="number" placeholder="रोख जमा" onchange="totalBalance()">
      <label for="message" aria-placeholder="OnlineAccount"></label>
      <select type="root" id="onlineAcc" name="onlineAcc">
      </select>
      <input type="number" id="online" name="number" placeholder="ऑनलाईन जमा " onchange="totalBalance()">
      <input type="number" id="discount" name="number" placeholder=" सूट रक्कम" onchange="totalBalance()">
    </div>

    <div>
      &nbsp;  &nbsp; &nbsp; जमा कॅरेट
      <input type="number" id="carate1100" name="number" placeholder="100" onchange="carate1()">
      <input type="number" id="carate1150" name="number" placeholder="150" onchange="carate1()">
      <input type="number" id="carate1250" name="number" placeholder="250" onchange="carate1()">
      <input type="number" id="carate1350" name="number" placeholder="350" onchange="carate1()">
      <input type="number" id="total2" name="number" placeholder="जमा कॅरेट रक्कम">
    </div>


    <div>
      <input type="text" id="note" name="name" placeholder="संदर्भ">
      <input type="number" id="baki" name="name" placeholder="बाकी रक्कम">
    </div>


    <button type="submit" class="save">Save</button>
  </div>
  </form>

</body>
<script src="./sale.js"></script>
<script src="./sale2.js"></script>




<script>
        
  document.addEventListener('DOMContentLoaded', function () {
      // Fetch data from API and populate Select2 dropdowns
      fetchAndPopulateDropdown('http://localhost:3000/list/Customer', 'grahk','name');
      fetchAndPopulateDropdown('http://localhost:3000/purchaseproductData', 'product','product_name');
      fetchAndPopulateDropdown('http://localhost:3000/purchaseproductData', 'bta','bata');
      fetchAndPopulateDropdown('http://localhost:3000/routeData', 'Route','route_name');
      fetchAndPopulateDropdown('http://localhost:3000/list/Bank Account', 'onlineAcc','name');
      fetchAndPopulateDropdown('http://localhost:3000/mobile', 'number','mobile_no');
  });

  function fetchAndPopulateDropdown(apiUrl, dropdownId,field) {
      fetch(apiUrl)
          .then(response => {
              if (!response.ok) {
                  throw new Error('Network response was not ok');
              }
              return response.json();
          })
          .then(data => {
              // Populate Select2 dropdown with API data
              populateDropdownWithSelect2(data, dropdownId,field);
          })
          .catch(error => {
              console.error('Error:', error);
          });
  }

  function populateDropdownWithSelect2(data, dropdownId, field) {
      var dropdown = $('#' + dropdownId);
      // Clear existing options
      dropdown.empty();

      // Add placeholder option
      dropdown.append($('<option></option>').attr('value', '').text('Select ' + dropdownId + ' type').prop('disabled', true).prop('selected', true));

      // Populate dropdown with API data
      data.forEach(function (item) {
          dropdown.append($('<option></option>').attr('value', item[field]).text(item[field]));
      });

      // Initialize Select2
      dropdown.select2({
          placeholder: "Select " + dropdownId + " type",
          allowClear: true
      });
  }

</script>



<script>



 function totalBalance(){
  var balance = parseInt(document.getElementById("bill1").value) || 0;
  var preBalance = parseInt(document.getElementById("previousBalance").value) || 0;
  var total1 = parseInt(document.getElementById("total1").value) || 0;

  fetch('http://localhost:3000/accountData/' + parseInt(document.getElementById("custid").value))
        .then(response => response.json())
        .then(data => {
            console.log(data[0].cr_dr_type)
            if(data[0].cr_dr_type == 'no'){
              document.getElementById("totalBill").value = balance + preBalance;         
            }else{
              document.getElementById("totalBill").value = total1 + balance + preBalance;
            }
            totalbill()
        })
        .catch(error => {
            console.error('Error:', error);
        });
  //document.getElementById("totalBill").value = total1 + balance + preBalance;
  //totalbill()
 } 

function previousbalance(){
  const name = document.getElementById("grahk").value

  fetch('http://localhost:3000/fetchName/name/' + name)
        .then(response => response.json())
        .then(data => {
            console.log(data[0].mobile_no)
            // Get the Select2 dropdown element
            var $productDropdown = $('#number');
            // Set the value of the Select2 dropdown if it's different
            if ($productDropdown.val() !== data[0].mobile_no) {
              $productDropdown.val(data[0].mobile_no).trigger('change');
            }

            var $routeDropdown = $('#Route');
            // Set the value of the Select2 dropdown if it's different
            if ($routeDropdown.val() !== data[0].route_detail) {
              $routeDropdown.val(data[0].route_detail).trigger('change');
            }



        })
        .catch(error => {
            console.error('Error:', error);
        });



  fetch('http://localhost:3000/fetchpv/' + name)
  .then(response => {
      if (!response.ok) {
          throw new Error('Network response was not ok');
      }
      return response.json();
  })
  .then(data => {
      // Populate dropdown with API data
      console.log(data)
      document.getElementById('custid').value = parseInt(data[0]['id']);
      document.getElementById('previousBalance').value = parseInt(data[0]['current_balance'] || 0);
      totalBalance();
      totalbill();

  })
  .catch(error => {
      console.error('Error:', error);
  });

}


function carate(){
  var value100 = parseInt(document.getElementById("carate100").value) || 0;
  var value150 = parseInt(document.getElementById("carate150").value) || 0;
  var value250 = parseInt(document.getElementById("carate250").value) || 0;
  var value350 = parseInt(document.getElementById("carate350").value) || 0;
  document.getElementById("total1").value = value100 * 100 + value150 * 150 + value250 * 250 + value350 * 350;
  totalbill();
  totalBalance();
  //document.getElementById("total1").value = parseInt(document.getElementById("carate100").value) * 100 +  parseInt(document.getElementById("carate150").value) * 150 +  parseInt(document.getElementById("carate250").value) * 250 +  parseInt(document.getElementById("carate350").value) * 350
}

function carate1(){
  var value100 = parseInt(document.getElementById("carate1100").value) || 0;
  var value150 = parseInt(document.getElementById("carate1150").value) || 0;
  var value250 = parseInt(document.getElementById("carate1250").value) || 0;
  var value350 = parseInt(document.getElementById("carate1350").value) || 0;
  document.getElementById("total2").value = value100 * 100 + value150 * 150 + value250 * 250 + value350 * 350;
  totalbill();
  //document.getElementById("total1").value = parseInt(document.getElementById("carate100").value) * 100 +  parseInt(document.getElementById("carate150").value) * 150 +  parseInt(document.getElementById("carate250").value) * 250 +  parseInt(document.getElementById("carate350").value) * 350
}


function totalbill(){
  console.log("totalbill")
  console.log(document.getElementById("custid").value)

  fetch('http://localhost:3000/accountData/' + parseInt(document.getElementById("custid").value))
        .then(response => response.json())
        .then(data => {
            console.log(data[0].cr_dr_type)
            if(data[0].cr_dr_type == 'no'){
              document.getElementById("baki").value = parseInt(document.getElementById("totalBill").value || 0) - parseInt(document.getElementById("bill_cash").value || 0) - parseInt(document.getElementById("online").value || 0) - parseInt(document.getElementById("discount").value || 0);
            }else{
              document.getElementById("baki").value = parseInt(document.getElementById("totalBill").value || 0) - parseInt(document.getElementById("bill_cash").value || 0) - parseInt(document.getElementById("online").value || 0) - parseInt(document.getElementById("discount").value || 0) - parseInt(document.getElementById("total2").value || 0);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });


  //document.getElementById("baki").value = parseInt(document.getElementById("totalBill").value || 0) - parseInt(document.getElementById("bill_cash").value || 0) - parseInt(document.getElementById("online").value || 0) - parseInt(document.getElementById("discount").value || 0) - parseInt(document.getElementById("total2").value || 0);
}


  function myFunction() {
    event.preventDefault();
  
    var formData = {
      bill_id: parseInt(document.getElementById('bill').value),
      bata: document.getElementById('bta').value,
      mark: document.getElementById('mark').value,
      product: document.getElementById('product').value,
      quantity: parseInt(document.getElementById('nag').value),
      rate: parseInt(document.getElementById('kimmat').value),
      price: parseInt(document.getElementById('total').value)
    };

    console.log(formData)

    fetch('http://localhost:3000/saleproductData/insertsaleproduct', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(result => {
        console.log('Entry added successfully:', result);
        document.getElementById('bill1').value = parseInt(document.getElementById('bill1').value || 0) + parseInt(document.getElementById('total').value);
        totalBalance()
        updateTable(formData, result);
      })
      .catch(error => {
        console.error('Error:', error);
      });
    alert('Button clicked!');
    // Add your desired functionality here
  }

  function updateTable(entry, result) {
    var tableBody = document.getElementById('tableBody1');
    var newRow = document.createElement('tr');
    newRow.innerHTML = `
          <td>${entry.product}</td>
          <td>${entry.bata}</td>
          <td>${entry.mark}</td>
          <td>${entry.quantity}</td>
          <td>${entry.rate}</td>
          <td>${entry.price}</td>
          <td><button type="button" onclick="deleteUser(this, ${result.insertId}, ${entry.price})">Delete</button></td>
      `;
    tableBody.appendChild(newRow);
  }

    function deleteUser(button,userId,price) {
      // Perform delete operation based on userId
      console.log(price)
      document.getElementById('bill1').value = parseInt(document.getElementById('bill1').value || 0) - price;
      totalBalance()
      var button = event.target;
      var row = button.parentNode.parentNode;
      fetch('http://localhost:3000/saleproductData/deletesaleproduct/' + userId, {
        method: 'DELETE'
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          console.log('User deleted successfully');
          // Refresh the table or update UI as needed
          //newRow.remove();
          row.remove();
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }
</script>

</html>
