<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <title></title>

    <style>
        /* Define your CSS styles here */
        body {
            font-family: Arial, sans-serif;
            background-color: rgba(242, 242, 242, 0.8);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        

        .container {
            /* margin: 0 auto;
            max-width: 800px;
            padding: 20px; */
            text-align: center;
            margin-bottom: 20px;
        }
        .drop {
            text-align: left;
            width: 100%; /* Full width */
            height: 40px;
            /* border-radius: 8px; */
            /* box-shadow: 5px 5px 5px grey; */
            margin-bottom: 10px; /* Add some space between dropdowns */
        }

        #border-hover, .button1 {
            padding: 12px 24px;
            text-decoration: none;
            color: white;
            background-color: #808080;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        
        #border-hover:hover, .button1 {
            background-color: #555;
        }
        
       
        
        .table-container {
            max-width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            margin: 0 auto;
            max-height: calc(100vh - 200px); /* Adjust the height as needed */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        th,
        td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 12px;
        }

        th {
            background-color: #f2f2f2;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            margin-right: 50px;
        }
        
        .input-row label {
            margin-right: 30px;
            font-weight: bold;
            color: #333; /* Label text color */
        }
        
        .popup {
            position: fixed; /* Position the popup */
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%); /* Center the popup */
            background-color: #fff; /* Background color */
            border: 1px solid #ccc; /* Border */
            border-radius: 5px; /* Rounded corners */
            padding: 20px; /* Padding */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); /* Box shadow */
            z-index: 9999; /* Ensure the popup is on top */
        }
        
        .popup h2 {
            margin-top: 0; /* Remove top margin */
            color: #333; /* Text color */
        }
        
        #barcodeCanvas {
            display: block; /* Make the canvas a block element */
            margin: 20px auto; /* Center the canvas */
            border: 1px solid #ccc; /* Border */
            border-radius: 5px; /* Rounded corners */
        }
        
        #downloadButton,
        button {
            padding: 10px 20px; /* Padding */
            margin: 10px; /* Margin */
            background-color: #808080; /* Background color */
            color: #fff; /* Text color */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Cursor on hover */
            transition: background-color 0.3s, color 0.3s; /* Smooth transition */
        }
        
        #downloadButton:hover,
        button:hover {
            background-color: #808080; /* Darker background color on hover */
        }
        
      
        /* Media query for responsiveness */
        @media only screen and (max-width: 600px) {
            .container {
                width: 100%; /* Full width on smaller screens */
            }
        }

/* Style the loader container */
#loader {
    border: 4px solid #f3f3f3; /* Light grey */
    border-top: 4px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite; /* Apply animation */
    display: none; /* Hide loader by default */
    
    /* Center the loader */
    position: absolute;
    top: 60%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  /* Animation */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  

  /* CSS */
.popup {
    /* Existing styles */
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

#companyInfo {
    margin-bottom: 20px;
}

#companyLogo {
    width: 100px; /* Adjust the width as needed */
    height: auto; /* Maintain aspect ratio */
}

#companyName {
    font-size: 1.2em; /* Adjust the font size as needed */
}

#barcodeCanvas {
    /* Existing styles */
    margin-top: 20px; /* Add margin for spacing */
    width: 220px;
}


    </style>
</head>

<body>
    <body>
        <div id="loader"></div>

        <div class="container">
            <h1 align="center">Product Barcode </h1>
            <hr><br>
    
            <div class="container1">
                <form id="Form">
    
                    <div class="input-row">
                        <label for="grahk">Product:  </label>
                        <select class="drop" id="grahk" name="account_group"></select>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label for="Route">Bata:   </label>
                        <select class="drop" id="Route" name="route_detail"></select>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label for="Route">Vehicle:   </label>
                        <select class="drop" id="vehicle" name="vehicle"></select>
                    </div>
                    <br>
                    <br>
                    <button id="border-hover" type="submit">Show </button>
                    <button id="border-hover"  type="button"  onclick="download()">Download </button>
                </form>
                <br>
                <br>
                <br>
    
                <div class="table-container">
                <table>
                    <tr>
                        <th></th>
                        <th>Purchase Id</th>
                        <th>Purchase Date</th>
                        <th>Product Name</th>
                        <th>Bata</th>
                        <th>Mark</th>
                        <th>Vehicle</th>
                        <th>Purchase Price</th>
                        <th>Selling Price</th>
                        <th>Barcode</th>
    
                    </tr>
                    <!-- Add more rows as needed -->
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
    
                    <div id="popupContainer"></div>
    
    
                </table>
                </div>
            </div>
          
<div id="popupContainer"></div>

    
    
</body>
<!-- <script src="./barcode.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/JsBarcode/3.11.5/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        fetchAndPopulateDropdown('http://65.0.168.11/purchaseproductData', 'grahk','product_name');
        fetchAndPopulateDropdown('http://65.0.168.11/purchaseproductData', 'Route','bata');
        fetchAndPopulateDropdown('http://65.0.168.11/vehicleData', 'vehicle','vehicle_no');
        
        var loader = document.getElementById('loader');
        loader.style.display = 'block';

        fetch('http://65.0.168.11/purchaseproductData/')
            .then(response => {
                if (response.status === 404) {
                    loader.style.display = 'none';
                    alert("No data found.");
                    throw new Error('Data not found');
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide loader
                loader.style.display = 'none';
                populateDropdown3(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });

    });


    function fetchAndPopulateDropdown(apiUrl, dropdownId,field) {
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Populate Select2 dropdown with API data
                populateDropdownWithSelect2(data, dropdownId,field);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function populateDropdownWithSelect2(data, dropdownId, field) {
        var dropdown = $('#' + dropdownId);
        // Clear existing options
        dropdown.empty();

        // Add placeholder option
        dropdown.append($('<option></option>').attr('value', '').text('Select ' + dropdownId + ' type').prop('disabled', true).prop('selected', true));

        // Populate dropdown with API data
        data.forEach(function (item) {
            dropdown.append($('<option></option>').attr('value', item[field]).text(item[field]));
        });

        // Initialize Select2
        dropdown.select2({
            placeholder: "Select " + field + "",
            allowClear: true
        });
    }

    $(document).on('select2:open', function(e) {
        window.setTimeout(function () {
            document.querySelector('input.select2-search__field').focus();
        }, 0);
    });


 
    function populateDropdown1(data) {
        var userNameDropdown = document.getElementById('Route');
        userNameDropdown.innerHTML = ''; // Clear existing options

        // Create and append new options based on API data
        data.forEach(function (item) {
            var option = document.createElement('option');
            option.value = item.bata; // Set the value
            option.textContent = item.bata; // Set the display text
            userNameDropdown.appendChild(option);
        });

        // Add a placeholder option
        var placeholderOption = document.createElement('option');
        placeholderOption.value = ""; // Set an empty value
        placeholderOption.textContent = "Select Bata"; // Set placeholder text
        placeholderOption.disabled = true; // Disable the option
        placeholderOption.selected = true; // Select the option by default
        userNameDropdown.insertBefore(placeholderOption, userNameDropdown.firstChild);
    }


    function populateDropdown2(data) {
        var userNameDropdown = document.getElementById('grahk');
        userNameDropdown.innerHTML = ''; // Clear existing options

        // Create and append new options based on API data
        data.forEach(function (item) {
            var option = document.createElement('option');
            option.value = item.product_name; // Set the value
            option.textContent = item.product_name; // Set the display text
            userNameDropdown.appendChild(option);
        });

        // Add a placeholder option
        var placeholderOption = document.createElement('option');
        placeholderOption.value = ""; // Set an empty value
        placeholderOption.textContent = "Select Product"; // Set placeholder text
        placeholderOption.disabled = true; // Disable the option
        placeholderOption.selected = true; // Select the option by default
        userNameDropdown.insertBefore(placeholderOption, userNameDropdown.firstChild);
    }


    function populateDropdown3(data) {
        var tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; // Clear existing rows

        var columnsToDisplay = ['purchase_id', 'p_date', 'product_name', 'bata', 'mark', 'gadi_number','purchase_price', 'selling_price'];
        data.forEach(function (item) {
            var row = tbody.insertRow();
            var cell = row.insertCell();
            columnsToDisplay.forEach(function (key) {
                var cell = row.insertCell();
                if (key == 'p_date') {
                    console.log(item[key])
                    var utcDate = new Date(item[key]);
                    var options = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        timeZone: 'Asia/Kolkata'
                    };
                    cell.textContent = utcDate.toLocaleString('en-IN', options);

                } else {
                    cell.textContent = item[key];
                }
            });

            // Add Info icon
            var infoCell = row.insertCell();
            var infoButton = document.createElement('button');
            infoButton.textContent = 'Info';
            infoButton.className = 'button1';
            infoButton.onclick = function () {
                displayBarcodePopup(item);
            };
            infoCell.appendChild(infoButton);

        });
    }

    

    function displayBarcodePopup(item) {
        var barcodeValue = 'Product Name:' + item['product_name'] + ' \nBata:' + item['bata'];
        var popupContent = `
            <div class="popup">
            
                <div id="companyInfo">
                    <p id="companyName">Savata Fruits</p> <!-- Added company name -->
                    <img src="../../assets/img/logo.png" alt="Company Logo" id="companyLogo"> <!-- Updated company logo path -->
                </div>
                <canvas id="barcodeCanvas"></canvas>
                <button id="downloadButton">Download Barcode</button>
                <button onclick="closePopup()">Close</button>
            </div>
        `;
        document.getElementById('popupContainer').innerHTML = popupContent;
        JsBarcode('#barcodeCanvas', barcodeValue, {
            format: "CODE128", // Adjust the barcode format as needed
            displayValue: true, // Hide text under the barcode 
            width: 1, // Set the width of the bars
            text: barcodeValue // Add text below the barcode
        });

            // Create a download link for the barcode image
    var downloadButton = document.getElementById('downloadButton');
    downloadButton.addEventListener('click', function () {
        //var svg = document.getElementById('barcodeCanvas');
        var canvas = document.getElementById('barcodeCanvas');
        //var svgData = new XMLSerializer().serializeToString(svg);
        //var image = new Image();
        var image = canvas.toDataURL('image/png');
        //image.src = 'data:image/svg+xml;base64,' + btoa(svgData);

        // Trigger download
        var link = document.createElement('a');
        link.href = image;
        link.download = item['product_name'] + '_' + item['bata'] + '_barcode.png'; // Set the filename based on concatenated values
        //document.body.appendChild(link);
        link.click();
        //document.body.removeChild(link);
    });

        
        document.querySelector('.popup').style.display = 'block';
    }



    function closePopup() {
        document.querySelector('.popup').style.display = 'none';
    }

    function getElementValueWithDefault(id, defaultValue) {
        var element = document.getElementById(id);
        return element && element.value ? element.value : defaultValue;
    }


    document.getElementById('Form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent form submission
        var data = {
            product : getElementValueWithDefault('grahk', '*') , 
            bata : getElementValueWithDefault('Route', '*'),
            gadi_number : getElementValueWithDefault('vehicle', '*') 
        };
        console.log(data);
        var loader = document.getElementById('loader');
        loader.style.display = 'block';
    
        fetch('http://65.0.168.11/purchaseproductData', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            loader.style.display = 'none';
            console.log(result)
            populateDropdown3(result)
            // Optionally, you can redirect or show a success message here
        })
        .catch(error => {
            console.error('Error:', error);
            // Optionally, you can display an error message here
        });
    });


    function download() {
        var data = {
            product: getElementValueWithDefault('grahk', '*'),
            bata: getElementValueWithDefault('Route', '*'),
            gadi_number: getElementValueWithDefault('vehicle', '*')
        };
        console.log(data);
        var loader = document.getElementById('loader');
        loader.style.display = 'block';

        fetch('http://65.0.168.11/purchaseproductData', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            loader.style.display = 'none';
            console.log(result);
            // Assuming result is an array of items
            generateBarcodesAndDownloadPDF(result);
        })
        .catch(error => {
            console.error('Error:', error);
            loader.style.display = 'none';
        });
    }


    function generateBarcodesAndDownloadPDF(items) {
            const { jsPDF } = window.jspdf;
            const barcodeWidth = 80; // Adjust the width to fit two barcodes in a row
            const barcodeHeight = 40;
            const itemsPerRow = 2; // Two items per row
            const rowsPerPage = 5; // Adjust this to fit the number of rows per page
            const itemsPerPage = itemsPerRow * rowsPerPage; // Calculate total items per page
            const spacing = 10; // Space between barcodes

            var pdf = new jsPDF(); // Create a new jsPDF instance

            items.forEach((item, index) => {
                var barcodeValue = 'Product Name:' + item['product_name'] + ' \nBata:' + item['bata'];

                // Create a canvas element for each barcode
                var canvas = document.createElement('canvas');
                JsBarcode(canvas, barcodeValue, {
                    format: "CODE128", // Adjust the barcode format as needed
                    displayValue: true, // Show text under the barcode
                    width: 1, // Set the width of the bars
                    text: barcodeValue // Add text below the barcode
                });

                // Convert the canvas to an image
                var image = canvas.toDataURL('image/png');

                // Calculate position for this barcode on the page
                const rowIndex = Math.floor((index % itemsPerPage) / itemsPerRow);
                const colIndex = index % itemsPerRow;

                const xOffset = 10 + (colIndex * (barcodeWidth + spacing));
                const yOffset = 20 + (rowIndex * (barcodeHeight + spacing));

                // Add the barcode image
                pdf.addImage(image, 'PNG', xOffset, yOffset, barcodeWidth, barcodeHeight); // Adjust position and size as needed

                // Add a new page if we've added itemsPerPage barcodes to the current page
                if ((index + 1) % itemsPerPage === 0 && index < items.length - 1) {
                    pdf.addPage();
                }
            });

            // Save the PDF
            pdf.save('barcodes.pdf');
        }

    

</script>
</html>