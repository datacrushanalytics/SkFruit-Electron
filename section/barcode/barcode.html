<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <title></title>

    <style>
        /* Define your CSS styles here */
        body {
            font-family: Arial, sans-serif;
            background-color: #fef7f7;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        

        .container {
            /* margin: 0 auto;
            max-width: 800px;
            padding: 20px; */
            text-align: center;
            margin-bottom: 20px;
        }
        .drop {
            text-align: left;
            width: 100%; /* Full width */
            height: 40px;
            /* border-radius: 8px; */
            /* box-shadow: 5px 5px 5px grey; */
            margin-bottom: 10px; /* Add some space between dropdowns */
        }

        #border-hover, .button1 {
            padding: 12px 24px;
            text-decoration: none;
            color: white;
            background-color: darkgrey;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        
        #border-hover:hover, .button1 {
            background-color: darkdarkgrey;
        }
        
       
        
        .table-container {
            max-width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            margin: 0 auto;
            max-height: calc(100vh - 200px); /* Adjust the height as needed */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        th,
        td {
            border: 1px solid #dddddd;
            background-color: #eafffb;
            text-align: left;
            padding: 12px;
        }

        th {
            background-color: #c7d5d3;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            margin-right: 50px;
        }
        
        .input-row label {
            margin-right: 30px;
            font-weight: bold;
            color: #333; /* Label text color */
        }
        
        .popup {
            position: fixed; /* Position the popup */
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%); /* Center the popup */
            background-color: #fff; /* Background color */
            border: 1px solid #ccc; /* Border */
            border-radius: 5px; /* Rounded corners */
            padding: 20px; /* Padding */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); /* Box shadow */
            z-index: 9999; /* Ensure the popup is on top */
        }
        
        .popup h2 {
            margin-top: 0; /* Remove top margin */
            color: #333; /* Text color */
        }
        
        #barcodeCanvas {
            display: block; /* Make the canvas a block element */
            margin: 20px auto; /* Center the canvas */
            border: 1px solid #ccc; /* Border */
            border-radius: 5px; /* Rounded corners */
        }
        
        #downloadButton,
        button {
            padding: 10px 20px; /* Padding */
            margin: 10px; /* Margin */
            background-color: darkgrey; /* Background color */
            color: #fff; /* Text color */
            border: none; /* Remove border */
            border-radius: 5px; /* Rounded corners */
            cursor: pointer; /* Cursor on hover */
            transition: background-color 0.3s, color 0.3s; /* Smooth transition */
        }
        
        #downloadButton:hover,
        button:hover {
            background-color: darkgrey; /* Darker background color on hover */
        }
        
      
        /* Media query for responsiveness */
        @media only screen and (max-width: 600px) {
            .container {
                width: 100%; /* Full width on smaller screens */
            }
        }

/* Style the loader container */
#loader {
    border: 4px solid #f3f3f3; /* Light grey */
    border-top: 4px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite; /* Apply animation */
    display: none; /* Hide loader by default */
    
    /* Center the loader */
    position: absolute;
    top: 60%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  /* Animation */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  

  /* CSS */
.popup {
    /* Existing styles */
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

#companyInfo {
    margin-bottom: 20px;
}

#companyLogo {
    width: 100px; /* Adjust the width as needed */
    height: auto; /* Maintain aspect ratio */
}

#companyName {
    font-size: 1.2em; /* Adjust the font size as needed */
}

#barcodeCanvas {
    /* Existing styles */
    margin-top: 20px; /* Add margin for spacing */
    width: 220px;
}

.first-row {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    .first-row label {
        margin-right: 10px;
        margin-top: 9px;
    }

    .first-row input,
    .first-row select {
        margin-right: 10px;
    }

    #todate {
        /* border-radius: 8px; */
        height: 30px;
        width: 200px;
        /* box-shadow: 5px 10px 8px grey;
        border-color: rgb(24, 24, 24); */
        text-indent: 10%;
        margin-left: 3px;
    }

    #fromdate {
        /* border-radius: 8px; */
        height: 30px;
        width: 200px;
        /* box-shadow: 5px 10px 8px grey;
        border-color: rgb(24, 24, 24); */
        text-indent: 10%;
        margin-right: 8%;
        margin-left: 10px;
    }


    </style>
</head>

<body>
    <body>
        <div id="loader"></div>

        <div class="container">
            <h1 align="center">Product Barcode </h1>
            <hr><br>
    
            <div class="container1">
                <form id="Form">
                    <div class="first-row">
                        <label for="userType">From Date :</label>
                        <input type="date" id="fromdate" name="date" placeholder="From Date" required>
                        <br>
                        <label for="userType">To Date :</label>
                        <input type="date" id="todate" name="date" placeholder="To Date" required>
                    </div> <br>
    
                    <div class="input-row">
                        <label for="grahk">Product:  </label>
                        <select class="drop" id="grahk" name="account_group" onchange="selectProduct()"></select>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label for="Route">Bata:   </label>
                        <select class="drop" id="Route" name="route_detail"></select>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <label for="Route">Vehicle:   </label>
                        <select class="drop" id="vehicle" name="vehicle"></select>
                    </div>
                    <br>
                    <br>
                    <button id="border-hover" style="background-color: #26a653;" type="submit">Show </button>
                    <button id="border-hover" style="background-color: #ff355f;" type="button"  onclick="download()">Download </button>
                </form>
                <br>
                <br>
                <br>
    
                <div class="table-container">
                <table>
                    <tr>
                        <th></th>
                        <th>Purchase Id</th>
                        <th>Purchase Date</th>
                        <th>Product Name</th>
                        <th>Bata</th>
                        <th>Mark</th>
                        <th>Vehicle</th>
                        <th>Purchase Price</th>
                        <th>Selling Price</th>
                        <th>Barcode</th>
    
                    </tr>
                    <!-- Add more rows as needed -->
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
    
                    <div id="popupContainer"></div>
    
    
                </table>
                </div>
            </div>
          
<div id="popupContainer"></div>

    
    
</body>
<!-- <script src="./barcode.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/JsBarcode/3.11.5/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
    
        const now = new Date();
        // Adjust to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
        const istTime = new Date(now.getTime() + istOffset);
        // Format the date to YYYY-MM-DD
        const todayIST = istTime.toISOString().split('T')[0];

        // Set the value of the date inputs to today's date in IST
        document.getElementById('fromdate').value = todayIST;
        document.getElementById('todate').value = todayIST;

        fetchAndPopulateDropdown('http://103.174.102.89:3000/purchaseproductData/product', 'grahk','product_name');
        fetchAndPopulateDropdown('http://103.174.102.89:3000/purchaseproductData/bata', 'Route','bata');
        fetchAndPopulateDropdown('http://103.174.102.89:3000/vehicleData', 'vehicle','vehicle_no');
        

   

    });


    function fetchAndPopulateDropdown(apiUrl, dropdownId,field) {
        console.log("Hello Deva",apiUrl)
        fetch(apiUrl)
            .then(response => {
                loader.style.display = 'none';
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Populate Select2 dropdown with API data
                populateDropdownWithSelect2(data, dropdownId,field);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function populateDropdownWithSelect2(data, dropdownId, field) {
        var dropdown = $('#' + dropdownId);
        // Clear existing options
        dropdown.empty();

        // Add placeholder option
        dropdown.append($('<option></option>').attr('value', '').text('Select ' + dropdownId + ' type').prop('disabled', true).prop('selected', true));

        // Populate dropdown with API data
        data.forEach(function (item) {
            dropdown.append($('<option></option>').attr('value', item[field]).text(item[field]));
        });

        // Initialize Select2
        dropdown.select2({
            placeholder: "Select " + field + "",
            allowClear: true
        });
    }

    $(document).on('select2:open', function(e) {
        window.setTimeout(function () {
            document.querySelector('input.select2-search__field').focus();
        }, 0);
    });


 
    function populateDropdown1(data) {
        var userNameDropdown = document.getElementById('Route');
        userNameDropdown.innerHTML = ''; // Clear existing options

        // Create and append new options based on API data
        data.forEach(function (item) {
            var option = document.createElement('option');
            option.value = item.bata; // Set the value
            option.textContent = item.bata; // Set the display text
            userNameDropdown.appendChild(option);
        });

        // Add a placeholder option
        var placeholderOption = document.createElement('option');
        placeholderOption.value = ""; // Set an empty value
        placeholderOption.textContent = "Select Bata"; // Set placeholder text
        placeholderOption.disabled = true; // Disable the option
        placeholderOption.selected = true; // Select the option by default
        userNameDropdown.insertBefore(placeholderOption, userNameDropdown.firstChild);
    }


    function populateDropdown2(data) {
        var userNameDropdown = document.getElementById('grahk');
        userNameDropdown.innerHTML = ''; // Clear existing options

        // Create and append new options based on API data
        data.forEach(function (item) {
            var option = document.createElement('option');
            option.value = item.product_name; // Set the value
            option.textContent = item.product_name; // Set the display text
            userNameDropdown.appendChild(option);
        });

        // Add a placeholder option
        var placeholderOption = document.createElement('option');
        placeholderOption.value = ""; // Set an empty value
        placeholderOption.textContent = "Select Product"; // Set placeholder text
        placeholderOption.disabled = true; // Disable the option
        placeholderOption.selected = true; // Select the option by default
        userNameDropdown.insertBefore(placeholderOption, userNameDropdown.firstChild);
    }


    function populateDropdown3(data) {
        var tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; // Clear existing rows

        var columnsToDisplay = ['purchase_id', 'p_date', 'product_name', 'bata', 'mark', 'gadi_number','purchase_price', 'selling_price'];
        data.forEach(function (item) {
            var row = tbody.insertRow();
            var cell = row.insertCell();
            columnsToDisplay.forEach(function (key) {
                var cell = row.insertCell();
                if (key == 'p_date') {
                    console.log(item[key])
                    var utcDate = new Date(item[key]);
                    var options = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        timeZone: 'Asia/Kolkata'
                    };
                    cell.textContent = utcDate.toLocaleString('en-IN', options);

                } else {
                    cell.textContent = item[key];
                }
            });

            // Add Info icon
            var infoCell = row.insertCell();
            var infoButton = document.createElement('button');
            infoButton.textContent = 'Info';
            infoButton.className = 'button1';
            infoButton.onclick = function () {
                displayBarcodePopup(item);
            };
            infoCell.appendChild(infoButton);

        });
    }


    function selectProduct(){
        var bataId = document.getElementById('grahk').value;
        console.log(bataId)
        var loader = document.getElementById('loader');
        loader.style.display = 'block';
        fetchAndPopulateDropdown('http://103.174.102.89:3000/purchaseproductData/bata/' + bataId, 'Route','bata');
    }

    

    
    function displayBarcodePopup(item) {
        console.log('barcode',item)
        // Convert the date to a JavaScript Date object
var utcDate = new Date(item.p_date);

// Convert the UTC date to IST (UTC+5:30)
const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
const istDate = new Date(utcDate.getTime() + istOffset);

// Extract day, month, and year and format as DD/MM/YYYY
const day = String(istDate.getDate()).padStart(2, '0');  // Add leading zero if needed
const month = String(istDate.getMonth() + 1).padStart(2, '0'); // Months are zero-based
const year = istDate.getFullYear();

// Combine the parts into DD/MM/YYYY format
const formattedISTDate = `${day}/${month}/${year}`;


        var barcodeValue = 'Product Name:' + item['product_name'].split('(')[0] + ' \nBata:' + item['bata'] + ' ' + formattedISTDate;
        var popupContent = `
            <div class="popup">
            
                <div id="companyInfo">
                    <p id="companyName">Savata Fruits</p> <!-- Added company name -->
                    <img src="../../assets/img/logo.png" alt="Company Logo" id="companyLogo"> <!-- Updated company logo path -->
                </div>
                <canvas id="barcodeCanvas"></canvas>
                <button id="downloadButton">Download Barcode</button>
                <button id="printButton">Print Barcode</button>
                <button onclick="closePopup()">Close</button>
            </div>
        `;
        document.getElementById('popupContainer').innerHTML = popupContent;
        JsBarcode('#barcodeCanvas', barcodeValue, {
            format: "CODE128", // Adjust the barcode format as needed
            displayValue: true, // Hide text under the barcode 
            width: 1, // Set the width of the bars
            text: barcodeValue // Add text below the barcode
        });

            // Create a download link for the barcode image
    var downloadButton = document.getElementById('downloadButton');
    downloadButton.addEventListener('click', function () {
        //var svg = document.getElementById('barcodeCanvas');
        var canvas = document.getElementById('barcodeCanvas');
        //var svgData = new XMLSerializer().serializeToString(svg);
        //var image = new Image();
        var image = canvas.toDataURL('image/png');
        //image.src = 'data:image/svg+xml;base64,' + btoa(svgData);

        // Trigger download
        var link = document.createElement('a');
        link.href = image;
        link.download = item['product_name'] + '_' + item['bata'] + '_barcode.png'; // Set the filename based on concatenated values
        //document.body.appendChild(link);
        link.click();
        //document.body.removeChild(link);
    });

    // Print barcode logic
    var printButton = document.getElementById('printButton');
    printButton.addEventListener('click', function () {
        printJS({
            printable: 'barcodeCanvas', // ID of the element to print
            type: 'html', // Type of content
            scanStyles: true, // Scan for styles
            targetStyles: ['*'] // Apply all styles
        });
    });

        
        document.querySelector('.popup').style.display = 'block';
    }




    function closePopup() {
        document.querySelector('.popup').style.display = 'none';
    }

    function getElementValueWithDefault(id, defaultValue) {
        var element = document.getElementById(id);
        return element && element.value ? element.value : defaultValue;
    }

    function formatDate(dateString) {
        var date = new Date(dateString);
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + date.getDate()).slice(-2);
        return year + '-' + month + '-' + day;
    }

    document.getElementById('Form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent form submission
        var data = {
            fromdate: formatDate(document.getElementById("fromdate").value),
            todate: formatDate(document.getElementById("todate").value),
            product : getElementValueWithDefault('grahk', '*') , 
            bata : getElementValueWithDefault('Route', '*'),
            gadi_number : getElementValueWithDefault('vehicle', '*'),
            barcode : 'yes',
            date : 'yes'
        };
        console.log(data); 
        var loader = document.getElementById('loader');
        loader.style.display = 'block';
    
        fetch('http://103.174.102.89:3000/purchaseproductData', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Product not found on this Bata.',
                    });
                loader.style.display = 'none';
                throw new Error('Network response was not ok');
            }
            console.log(response)
            return response.json();
        })
        .then(result => {
            loader.style.display = 'none';
            console.log(result)
            populateDropdown3(result)
            // Optionally, you can darkgreyirect or show a success message here
        })
        .catch(error => {
            console.error('Error:', error);
            // Optionally, you can display an error message here
        });
    });


    function download() {
        var data = {
            fromdate: formatDate(document.getElementById("fromdate").value),
            todate: formatDate(document.getElementById("todate").value),
            product : getElementValueWithDefault('grahk', '*') , 
            bata : getElementValueWithDefault('Route', '*'),
            gadi_number : getElementValueWithDefault('vehicle', '*'),
            barcode : 'yes',
            date : 'yes'
        };
        console.log(data);
        var loader = document.getElementById('loader');
        loader.style.display = 'block';

        fetch('http://103.174.102.89:3000/purchaseproductData', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Product not found on this Bata.',
                    });
        
                loader.style.display = 'none';
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            loader.style.display = 'none';
            console.log(result);
            // Assuming result is an array of items
            generateBarcodesAndDownloadPDF(result);
        })
        .catch(error => {
            console.error('Error:', error);
            loader.style.display = 'none';
        });
    }


// function generateBarcodesAndDownloadPDF(items) {
//     const { jsPDF } = window.jspdf;

//      // Dimensions for labels and barcode
//     const pageWidth = 50; // Page width in mm
//     const labelHeight = 30; // Label height
// //     const verticalMargin = 0; // Margin between labels

// //     // Calculate total required height
//     const gap = 3; // Gap between labels in mm
//     const labelWithGapHeight = labelHeight + gap;
//     const totalHeight = items.length * labelWithGapHeight;
//     console.log(totalHeight, labelWithGapHeight , "totalHeight")
//     // const totalHeight = items.length * labelHeight;

//     // Sticker dimensions in mm
//     const stickerWidth = 50; // Sticker width
//     const stickerHeight = 30; // Sticker height

//     // Barcode dimensions in mm
//     const barcodeWidth = 35; // Barcode width
//     const barcodeHeight = 20; // Barcode height

//     // Logo dimensions in mm
//     const logoWidth = 10; // Logo width
//     const logoHeight = 10; // Logo height

//     // Margins within the sticker
//     const horizontalMargin = 4; // Horizontal margin
//     const verticalMargin = 2; // Vertical margin

//     // Number of stickers per row and column
//     const stickersPerRow = Math.floor(210 / stickerWidth); // A4 width is 210mm
//     const stickersPerColumn = Math.floor(297 / stickerHeight); // A4 height is 297mm
//     const stickersPerPage = stickersPerRow * stickersPerColumn;

//     // Create a new PDF instance
//     const pdf = new jsPDF({
//         unit: "mm",
//         format: [pageWidth, totalHeight], // A4 size
//     });

//     items.forEach((item, index) => {
//         const barcodeValue = `Product: ${item.product_name.split('(')[0]}\nBata: ${item.bata}`;

//         // Create a canvas for the barcode
//         const canvas = document.createElement('canvas');
//         JsBarcode(canvas, barcodeValue, {
//             format: "CODE128",
//             displayValue: true,
//             width: 1, // Adjust barcode bar width 
//             textMargin: 1, // Space between barcode and text,
//             text: barcodeValue,
//         });

//         // Convert the canvas to an image
//         const barcodeImage = canvas.toDataURL('image/png');

//         // Calculate row and column positions
//         const rowIndex = Math.floor(index / stickersPerRow) % stickersPerColumn; // Current row
//         const colIndex = index % stickersPerRow; // Current column

//         // Calculate the x and y position for this sticker
//         // const xOffset = colIndex * stickerWidth + horizontalMargin;
//         // const yOffset = rowIndex * stickerHeight + verticalMargin;

//         // Calculate the y position for this label
//         const yOffset = index * labelHeight + (index > 0 ? 0 : 3 ) + verticalMargin;
// //         console.log("index", index, yOffset , labelHeight, verticalMargin) 
//         // Add the barcode image
//         pdf.addImage(barcodeImage, "PNG", 4, yOffset, barcodeWidth, barcodeHeight);

//         // Add a new page if the current page is full
//         if ((index + 1) % stickersPerPage === 0 && index < items.length - 1) {
//             pdf.addPage();
//         }
//     });

//     // Save the PDF file
//     pdf.save("barcodes.pdf");
// }
    

// function generateBarcodesAndDownloadPDF(items) {
//     const { jsPDF } = window.jspdf;

//     // Page dimensions in mm
//     // const pageWidth = 50; // Page width in mm
//     // const pageHeight = 40; // Page height in mm

//     // // Label dimensions in mm
//     // const labelWidth = 50; // Label width
//     // const labelHeight = 40; // Label height

//     // // Barcode dimensions in mm
//     // const barcodeWidth = 35; // Barcode width
//     // const barcodeHeight = 20; // Barcode height

//     // // Margins within each label
//     // const horizontalMargin = 1; // Horizontal margin
//     // const verticalMargin = 2; // Vertical margin

//     // // Number of labels per row and column
//     // const labelsPerRow = Math.floor(pageWidth / labelWidth);
//     // const labelsPerColumn = Math.floor(pageHeight / labelHeight);

//       // Dimensions for labels and barcode
//     const pageWidth = 50; // Page width in mm
//     const labelHeight = 40; // Label height
//     const barcodeWidth = 35; // Barcode width
//     const barcodeHeight = 20; // Barcode height
//     const verticalMargin = 2; // Margin between labels


//     // Number of stickers per row and column
//     // const stickersPerRow = Math.floor(210 / stickerWidth); // A4 width is 210mm
//     // const stickersPerColumn = Math.floor(297 / stickerHeight); // A4 height is 297mm
//     // const stickersPerPage = stickersPerRow * stickersPerColumn;
//     const totalHeight = items.length * labelHeight;

//     // Create a new PDF instance
//     const pdf = new jsPDF({
//         unit: "mm",
//         format: [pageWidth, totalHeight], // Set custom page size
//     });

//     items.forEach((item, index) => {
//         // Format date
//         const utcDate = new Date(item.p_date);
//         const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
//         const istDate = new Date(utcDate.getTime() + istOffset);

//         const day = String(istDate.getDate()).padStart(2, '0');
//         const month = String(istDate.getMonth() + 1).padStart(2, '0'); // Months are zero-based
//         const year = istDate.getFullYear();
//         const formattedISTDate = `${day}/${month}/${year}`;

//         // Barcode value
//         const barcodeValue = `Product: ${item.product_name.split('(')[0]}\nBata: ${item.bata} ${formattedISTDate}`;

//         // Create a canvas for the barcode
//         const canvas = document.createElement('canvas');
//         JsBarcode(canvas, barcodeValue, {
//             format: "CODE128",
//             displayValue: true,
//             width: 1, // Adjust barcode width
//             textMargin: 1, // Space between barcode and text
//             text: barcodeValue,
//         });

//         // Convert the canvas to an image
//         const image = canvas.toDataURL('image/png');

//         // Calculate row and column positions
//         // const rowIndex = Math.floor(index / labelsPerRow) % labelsPerColumn; // Current row
//         // const colIndex = index % labelsPerRow; // Current column

//         // // Calculate the x and y position for this label
//         // const xOffset = colIndex * labelWidth + horizontalMargin;
//         // const yOffset = rowIndex * labelHeight + verticalMargin;
//         // console.log("xOffset", xOffset, "yOffset", yOffset)

//         const yOffset = index * labelHeight + verticalMargin;


//         // Add the barcode image to the PDF
//         pdf.addImage(image, 'PNG', 3, yOffset + 1, barcodeWidth, barcodeHeight);

//         // if (
//         //     xOffset + labelWidth > pageWidth || // Horizontal space overflow
//         //     yOffset + labelHeight > pageHeight // Vertical space overflow
//         // ) {
//         //     pdf.addPage();
//         // }

//         // if ((index + 1) % (labelsPerRow * labelsPerColumn) === 0 && index < items.length - 1) {
//         //     console.log("labelsPerRow * labelsPerColumn",labelsPerRow * labelsPerColumn)
//         //     pdf.addPage();
//         // }


//     });
//     // Add a new page if the current page is full
    
//     // Save the PDF file
//     pdf.save('barcodes.pdf');
// }



function generateBarcodesAndDownloadPDF(items) {
    const { jsPDF } = window.jspdf;

    // Dimensions for labels and barcode
    const pageWidth = 50; // Page width in mm
    const pageHeight = 40; // Custom page height in mm
    const labelHeight = 30; // Label height
    const barcodeWidth = 35; // Barcode width
    const barcodeHeight = 20; // Barcode height
    const gap = 3; // Gap between labels in mm
    const labelWithGapHeight = labelHeight + gap;

    // Create a new PDF instance with the specified page size
    const pdf = new jsPDF({
        unit: "mm",
        format: [pageWidth, pageHeight],
        orientation: "p",
    });

    let yOffset = 3.5; // Start position on the first page

    items.forEach((item, index) => {
        // Format date
        const utcDate = new Date(item.p_date);
        const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
        const istDate = new Date(utcDate.getTime() + istOffset);

        const day = String(istDate.getDate()).padStart(2, '0');
        const month = String(istDate.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = istDate.getFullYear();
        const formattedISTDate = `${day}/${month}/${year}`;

        // Barcode value
        const barcodeValue = `${item.product_name.split('(')[0]}: ${item.bata}`;
        const barcodeValue1 = `Product: ${item.product_name.split('(')[0]}\nBata: ${item.bata} ${formattedISTDate}`;

        // Create a canvas for the barcode
        const canvas = document.createElement('canvas');
        JsBarcode(canvas, barcodeValue, {
            format: "CODE128",
            displayValue: true,
            width: 5, // Adjust barcode width
            textMargin: 1, // Space between barcode and text
            text: barcodeValue1,
        });

        // Convert the canvas to an image
        const image = canvas.toDataURL('image/png');

        // Check if the barcode fits on the current page
        if (yOffset + labelWithGapHeight > 40 * 2) {
            pdf.addPage(); // Add a new page
            yOffset = 3.5; // Reset yOffset for the new page
        }

        // Add the barcode image to the PDF
        console.log(index, 3, yOffset, barcodeWidth, barcodeHeight)
        pdf.addImage(image, 'PNG', 3.5, yOffset, barcodeWidth, barcodeHeight);

        // Update yOffset for the next barcode
        yOffset += labelHeight - 3.5;
    });

    // Trigger the print operation
    pdf.autoPrint();
    window.open(pdf.output('bloburl'), '_blank');
}




// function generateBarcodesAndDownloadPDF(items) {
//     const { jsPDF } = window.jspdf;

//     // Sticker dimensions in mm
//     const stickerWidth = 38; // Sticker width
//     const stickerHeight = 25; // Sticker height

//     // Barcode dimensions in mm
//     const barcodeWidth = 30; // Barcode width
//     const barcodeHeight = 10; // Barcode height

//     // Logo dimensions in mm
//     const logoWidth = 10; // Logo width
//     const logoHeight = 10; // Logo height

//     // Margins within the sticker
//     const horizontalMargin = 4; // Horizontal margin
//     const verticalMargin = 2; // Vertical margin

//     // Number of stickers per row and column
//     const stickersPerRow = Math.floor(210 / stickerWidth); // A4 width is 210mm
//     const stickersPerColumn = Math.floor(297 / stickerHeight); // A4 height is 297mm
//     const stickersPerPage = stickersPerRow * stickersPerColumn;

//     // Create a new PDF instance
//     const pdf = new jsPDF({
//         unit: "mm",
//         format: "a4", // A4 size
//     });

//     items.forEach((item, index) => {
//         const barcodeValue = `Product: ${item.product_name.split('(')[0]}\nBata: ${item.bata}`;

//         // Create a canvas for the barcode
//         const canvas = document.createElement('canvas');
//         JsBarcode(canvas, barcodeValue, {
//             format: "CODE128",
//             displayValue: true,
//             width: 1, // Adjust barcode bar width
//             height: barcodeHeight, // Barcode height
//             textMargin: 2, // Space between barcode and text
//             fontSize: 8, // Text font size
//         });

//         // Convert the canvas to an image
//         const barcodeImage = canvas.toDataURL('image/png');

//         // Calculate row and column positions
//         const rowIndex = Math.floor(index / stickersPerRow) % stickersPerColumn; // Current row
//         const colIndex = index % stickersPerRow; // Current column

//         // Calculate the x and y position for this sticker
//         const xOffset = colIndex * stickerWidth + horizontalMargin;
//         const yOffset = rowIndex * stickerHeight + verticalMargin;

//         // Add logo to the PDF
//         pdf.addImage("../../assets/img/logo.png", "PNG", xOffset + 4, yOffset, logoWidth, logoHeight);

//         // Add company name below the logo
//         pdf.setFontSize(8);
//         pdf.text("Savata Fruits", xOffset + logoWidth + 2, yOffset + 6);

//         // Add the barcode image
//         pdf.addImage(barcodeImage, "PNG", xOffset + 4, yOffset + logoHeight + 2, barcodeWidth, barcodeHeight);

//         // Add a new page if the current page is full
//         if ((index + 1) % stickersPerPage === 0 && index < items.length - 1) {
//             pdf.addPage();
//         }
//     });

//     // Save the PDF file
//     pdf.save("barcodes.pdf");
// }
    
    

</script>
</html>