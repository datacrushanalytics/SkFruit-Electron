<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="../sale/sale.css">
  <title></title>
  <style>
    #input13 {
      margin: 1px;
      width: auto;
      text-align: left;
    }



    body {
      font-family: Arial, sans-serif;
      background-color: #fef7f7;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      text-align: center;
      margin-bottom: 20px;
      padding: 0 20px;
    }

    .table-container {
      overflow-x: auto;
      margin: 0 auto;
      max-width: 100%;
      min-width: 600px;
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      min-width: 100%;
      border-collapse: collapse;
      background-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
    }

    th,
    td {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 12px;
    }

    th {
      background-color: #f2f2f2;
    }

    button {
      background-color: grey;
      color: white;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: darkgrey;
    }

    /* Adjustments for input elements */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      height: 40px;
      width: calc(100% - 20px);
      /* Adjusted width */
      margin: 10px;
      padding: 0 10px;
      /* Adjusted padding */
      border-radius: 5px;
      /* Added border-radius */
      box-sizing: border-box;
    }

    /* Adjustments for labels */
    label {
      margin: 10px;
    }

    /* Adjustments for buttons */
    .save {
      margin: 20px;
      /* Added margin */
    }

    /* Adjustments for table rows */
    .table-row {
      text-align: center;
      /* Center align table rows */
    }

    /* CSS for bill and date container */
    .bill-date-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    /* CSS for individual input wrappers */
    .input-wrapper {
      display: flex;
      flex: 1;
      align-items: center;
      margin: 0 5px;
      /* darkgreyuce the margin between input wrappers */
    }

    /* Adjustments for input elements */
    .input-wrapper input[type="text"],
    .input-wrapper input[type="number"],
    .input-wrapper input[type="date"],
    .input-wrapper select {
      flex: 1;
      margin-right: 0;
      /* Remove margin between input boxes */
    }

    /* Adjustments for labels */
    .input-wrapper label {
      margin-right: 10px;
      /* Add margin between label and input box */
      width: 100px;
      /* Fixed width for labels */
      text-align: right;
      /* Align label text to the right */
    }

    /* Adjustments for individual input wrappers */
    #bill-wrapper,
    #date-wrapper {
      margin-right: 10px;
      /* darkgreyuce the margin between input wrappers */
    }

    .dropdown-container {
      display: flex;
      justify-content: space-between;
      /* Distribute space evenly between dropdowns */
      margin-bottom: 10px;
      /* Add margin between the dropdown container and other elements */
    }

    .dropdown-container .input-wrapper {
      flex: 1;
      /* Each dropdown takes equal width */
      margin-right: 10px;
      /* Add space between dropdowns */
    }

    .dropdown-container .input-wrapper:last-child {
      margin-right: 0;
      /* Remove margin from the last dropdown */
    }



    .row-container .input-wrapper {
      flex: 1;
      /* Each dropdown takes equal width */
      margin-right: 10px;
      /* Add space between dropdown and button */
    }

    .row-container .button-wrapper {
      flex: 1;
      /* Button takes equal width as dropdown */
    }

    .row-container {
      display: flex;
      align-items: center;
      /* Align items vertically */
      margin-bottom: 10px;
      /* Add margin between the row container and other elements */
    }

    .row-container label {
      margin-right: 10px;
      /* Add space between label and inputs */
    }

    .row-container .carat-inputs {
      display: flex;
      align-items: left;
      /* Align items vertically */
    }

    .row-container .input-wrapper:last-child {
      margin-right: 0;
      /* Remove margin for the last input wrapper */
    }

    .totalCarat {
      margin-left: auto;
      /* Push the total carat container to the right */
    }

    .row-container1 {
      display: flex;
      margin-bottom: 10px;
      /* Add margin between rows */
      margin-left: 50%;
      margin-right: 10%;
    }

    .row-container1 label {
      margin-left: auto;
      /* Move the label to the right side */
      margin-right: 10px;
      /* Add space between label and input */
    }

    /* Style the loader container */
    #loader {
      border: 4px solid #f3f3f3;
      /* Light grey */
      border-top: 4px solid #3498db;
      /* Blue */
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      /* Apply animation */
      display: none;
      /* Hide loader by default */

      /* Center the loader */
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Animation */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }


    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border: 1px solid #ccc;
      box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
      z-index: 9999;
      width: 80%;
      /* Adjust the width as desidarkgrey */
      height: 80%;
      /* Adjust the height as desidarkgrey */
      max-width: 90vw;
      /* Set maximum width relative to viewport width */
      max-height: 90vh;
      /* Set maximum height relative to viewport height */
      overflow: auto;
      /* Add scrollbars if content overflows */
    }

    .popup-content {
      width: 100%;
      /* Adjust the width as desidarkgrey */
      height: 100%;
      /* Adjust the height as desidarkgrey */
    }

    .popup-content iframe {
      width: 100%;
      /* Adjust the width as desidarkgrey */
      height: 100%;
      /* Adjust the height as desidarkgrey */
    }

    .close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }

    /* Styles for the modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }


    /* Styles for the modal content */
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      position: relative;
      /* Position relative for the close button */
    }



    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>

</head>

<body>
  <div id="loader"></div>
  <div class="container">
    <h1 align="center">विक्री </h1>
    <hr>
    <form id="login">

      <div class="bill-date-container">
        <div id="bill-wrapper" class="input-wrapper">
          <label for="bill">बिल नं :</label>
          <input type="text" id="bill" name="number" placeholder="बिल नं." required readonly>
        </div>

        <div id="date-wrapper" class="input-wrapper">
          <label for="date">दिनांक :</label>
          <input type="date" id="date" name="date" required>
        </div>
      </div>


      <div class="dropdown-container">
        <div id="grahk-wrapper" class="input-wrapper">
          <label for="grahk">ग्राहकाचे नाव :</label>
          <select type="root" id="grahk" name="root" onchange="previousbalance()" required></select>
        </div>
        <div id="number-wrapper" class="input-wrapper">
          <label for="number">मोबाइल नं :</label>
          <select type="root" id="number" name="number" onchange="getCust()" required></select>
        </div>
      </div>


      <div class="row-container">
        <div id="Route-wrapper" class="input-wrapper">
          <label for="Route">रूट :</label>
          <select type="root" id="Route" name="root" onchange="setCustomer()" required></select>
          <input type="hidden" id="custid" name="custid">
        </div>

        <div class="button-wrapper">
          <button type="button" id="account-page-button" style="background-color: #18b3a4;" onclick="goToAccountPage(event)">Add Customer</button>
        </div>

        <div class="button-wrapper">
        </div>
        <button type="button" style="background-color: #ff355f;" onclick="openPopup(event)">Ledger</button>
        <div class="popup" id="popup">
          <div class="popup-content">
            <span class="close" onclick="closePopup()">&times;</span>
            <iframe id="popupIframe" frameborder="0" scrolling="auto"></iframe>
          </div>
        </div>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="address">पत्ता :</label>
          <input type="text" id="address" name="address" placeholder="पत्ता" required>
        </div>

        <div class="input-wrapper">
          <label for="sandarbh">संदर्भ :</label>
          <input type="text" id="sandarbh" name="sandarbh" placeholder="संदर्भ">
        </div>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="bta">बटा :</label>
          <select type="root" id="bta" name="bta" onchange="getProducts()"></select>
          <!-- <button onclick="openScanner()">Scan Barcode</button> -->
          &nbsp; &nbsp;
          <!-- <i class="fa-solid fa-scanner-gun" onclick="openScanner()"></i> -->
          <!-- <i class="fa-sharp-duotone fa-solid fa-barcode-scan"></i> -->
          <!-- <i class="fa-sharp-duotone fa-solid fa-scanner-touchscreen"></i> -->
          <i class="fa-sharp-duotone fa-solid fa-barcode scanner-icon" onclick="openScannerModal()"></i>
        </div>
        <div id="scannerModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeScannerModal1()">&times;</span>
            <p>Scan barcode here:</p>
            <input type="text" id="barcodeInput" placeholder="Scan barcode here" oninput="handleBarcodeInput(event)">
          </div>
        </div>

        <div class="input-wrapper">
          <label for="mark">मार्क :</label>
          <input type="text" id="mark" name="mark" placeholder="मार्क">
        </div>

        <div class="input-wrapper">
          <label for="product">Product :</label>
          <select type="root" id="product" name="product" onchange="updateTotal()"></select>
        </div>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="nag" id="nagLabel">नग :</label>
          <input type="text" id="nag" name="nag" placeholder="नग" value="1" onchange="updateTotal()">
          <input type="hidden" id="nag1" name="nag1">
        </div>

        <div class="input-wrapper">
          <label for="kimmat">किंमत :</label>
          <input type="number" id="kimmat" name="kimmat" placeholder="किंमत" onchange="updateTotal()">
        </div>

        <div class="input-wrapper">
          <label for="total">रक्कम :</label>
          <input type="number" id="total" name="total" placeholder="रक्कम" readonly>
        </div>

        <div class="button-wrapper">
          <button type="button" style="background-color: #26a653;" onclick="myFunction()" class="button">ADD</button>
        </div>
      </div>


      <br>
      <table>
        <tr>
          <th>प्रॉडक्ट</th>
          <th>बटा</th>
          <th>मार्क</th>
          <th>नग</th>
          <th>किंमत</th>
          <th>रक्कम</th>
        </tr>

        <!-- Add more rows as needed -->
        <tbody id="tableBody1">
          <!-- Data will be inserted here -->
        </tbody>
      </table>
      <br>
      <br>


      <div class="row-container">
        <label>गेलेले कॅरेट :</label>
        <div class="carat-inputs">
          <div class="input-wrapper">
            <label for="carate100">100 :</label>
            <input type="number" id="carate100" name="carate100" min="0" placeholder="100" onchange="carate()">
          </div>
          <div class="input-wrapper">
            <label for="carate150">150 :</label>
            <input type="number" id="carate150" name="carate150" min="0" placeholder="150" onchange="carate()">
          </div>
          <div class="input-wrapper">
            <label for="carate250">250 :</label>
            <input type="number" id="carate250" name="carate250" min="0" placeholder="250" onchange="carate()">
          </div>
          <div class="input-wrapper">
            <label for="carate350">350 :</label>
            <input type="number" id="carate350" name="carate350" min="0" placeholder="350" onchange="carate()">
          </div>
        </div>
      </div>
      <div class="row-container1">
        <label for="totalCarat">एकूण कॅरेट :</label>
        <input type="number" id="total1" name="totalCarat" placeholder="गेलेले कॅरेट रक्कम" readonly>
      </div>


      <div class="row-container1">
        <label for="totalCarat">बिल रक्कम :</label>
        <input type="number" id="bill1" name="number" placeholder="बिल रक्कम" onchange="totalBalance()" readonly>
      </div>
      <div class="row-container1">
        <label for="totalCarat">मागील बाकी :</label>
        <input type="number" id="previousBalance" name="number" placeholder="मागील बाकी" readonly>
      </div>
      <div class="row-container1">
        <label for="totalCarat">एकूण रक्कम :</label>
        <input type="number" id="totalBill" name="number" placeholder="एकूण रक्कम" readonly>
      </div>

      <div class="row-container1">
        <label for="totalCarat">रोख जमा :</label>
        <input type="number" id="bill_cash" name="number" placeholder="रोख जमा" onchange="totalBalance()">
      </div>
      <div class="row-container1">
        <label for="totalCarat">ऑनलाईन जमा बँक :</label>
        <select type="root" id="onlineAcc" name="onlineAcc" onchange="toggleReadonly()">
        </select>
      </div>
      <div class="row-container1">
        <label for="totalCarat">ऑनलाईन जमा :</label>
        <input type="number" id="online" name="number" placeholder="ऑनलाईन जमा" onchange="totalBalance()" readonly>
      </div>
      <div class="row-container1">
        <label for="totalCarat">सूट रक्कम :</label>
        <input type="number" id="discount" name="number" placeholder="सूट रक्कम" onchange="totalBalance()">
      </div>

      <div class="row-container">
        <label>जमा कॅरेट :</label>
        <div class="carat-inputs">
          <div class="input-wrapper">
            <label for="carate100">100 :</label>
            <input type="number" id="carate1100" name="carate100" min="0" placeholder="100" onchange="carate1()">
          </div>
          <div class="input-wrapper">
            <label for="carate150">150 :</label>
            <input type="number" id="carate1150" name="carate150" min="0" placeholder="150" onchange="carate1()">
          </div>
          <div class="input-wrapper">
            <label for="carate250">250 :</label>
            <input type="number" id="carate1250" name="carate250" min="0" placeholder="250" onchange="carate1()">
          </div>
          <div class="input-wrapper">
            <label for="carate350">350 :</label>
            <input type="number" id="carate1350" name="carate350" min="0" placeholder="350" onchange="carate1()">
          </div>
        </div>
      </div>
      <div class="row-container1">
        <label for="totalCarat">एकूण जमा कॅरेट :</label>
        <input type="number" id="total2" name="totalCarat" placeholder="जमा कॅरेट रक्कम" readonly>
      </div>

      <div class="row-container">
        <div class="input-wrapper">
          <label for="note">Note :</label>
          <input type="text" id="note" name="note" placeholder="Note">
        </div>

        <div class="input-wrapper">
          <label for="baki">बाकी रक्कम :</label>
          <input type="number" id="baki" name="baki" placeholder="बाकी रक्कम" readonly>
        </div>
      </div>

      <div class="row-container">
        <label>बाकी कॅरेट :</label>
        <div class="carat-inputs">
          <div class="input-wrapper">
            <label for="carate100">100 :</label>
            <input type="number" id="carate2100" name="carate2100" min="0" placeholder="100" readonly>
            <input type="hidden" id="carate22100" name="carate22100" placeholder="100" readonly>
          </div>
          <div class="input-wrapper">
            <label for="carate150">150 :</label>
            <input type="number" id="carate2150" name="carate2150" min="0" placeholder="150" readonly>
            <input type="hidden" id="carate22150" name="carate22150" placeholder="150" readonly>
          </div>
          <div class="input-wrapper">
            <label for="carate250">250 :</label>
            <input type="number" id="carate2250" name="carate2250" min="0" placeholder="250" readonly>
            <input type="hidden" id="carate22250" name="carate22250" placeholder="250" readonly>
          </div>
          <div class="input-wrapper">
            <label for="carate350">350 :</label>
            <input type="number" id="carate2350" name="carate2350" min="0" placeholder="350" readonly>
            <input type="hidden" id="carate22350" name="carate22350" placeholder="350" readonly>
          </div>
        </div>
      </div>

      <button type="button" style="background-color: #26a653;" class="save" onclick="insertSale()">Save</button>
      <button type="button" style="background-color: #ff355f;" class="save" onclick="confirmAndProceed()">Back</button>
  </div>
  </form>

</body>
<script src="../sale/sale.js"></script>
<script src="../sale/sale2.js"></script>
<!-- <Script src="../../report/routewiseSaleReport/routewiseSaleReport.js"></Script> -->




<script>

  document.addEventListener('DOMContentLoaded', async function () {
    // Fetch data from API and populate Select2 dropdowns
     // Get the current date
     var currentDate = new Date();
    // Format the date as mm/dd/yyyy
    var formattedDate = currentDate.getFullYear() + '-' + (String(currentDate.getMonth() + 1).padStart(2, '0')) + '-' + (String(currentDate.getDate()).padStart(2, '0'));
    // Set the placeholder of the input field to the formatted date
    console.log(formattedDate);
    document.getElementById('date').value = formattedDate;

    var sessionData = JSON.parse(localStorage.getItem('sessionData'));
    // Check if session data exists and if the user is an admin
    var isAdmin = sessionData && sessionData[0].usertype === 'Admin';
    console.log("Admin",isAdmin)
    // Check if the user is an admin and show/hide the button accordingly
    if (!isAdmin) {
        document.getElementById('date').readOnly = true; // Hide the button for non-admin users
    }



    fetch('http://103.174.102.89:3000/fetchSaleid')
        .then(response => {
            if (response.status === 404) {
                loader.style.display = 'none';
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'No data found.',
                });
                throw new Error('Data not found');
            }
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Populate dropdown with API data
            document.getElementById('bill').value = parseInt(data[0]['num']) + 1 || 1;
            fetch('http://103.174.102.89:3000/saleproductData/' + (parseInt(data[0]['num']) + 1) || 1)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Populate dropdown with API data
                    //populateDropdown3(data);
                    data.forEach(function (item) {
                        updateTable(item, item.id);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        })
        .catch(error => {
            console.error('Error:', error);
        });


    var sessionData = JSON.parse(localStorage.getItem('sessionData'));
    // Check if session data exists and if the user is an admin
    var isAdmin = sessionData && sessionData[0].usertype === 'Admin';
        // Check if the user is an admin and show/hide the button accordingly
    if (isAdmin) {
      await fetchAndPopulateDropdown('http://103.174.102.89:3000/mobile', 'number', 'mobile_no');
      await fetchAndPopulateDropdown('http://103.174.102.89:3000/routeData', 'Route', 'route_name');
      await fetchAndPopulateDropdown('http://103.174.102.89:3000/list/Customer', 'grahk', 'name');
    }else{
      var route = sessionData[0].route;
      await fetchAndPopulateDropdown('http://103.174.102.89:3000/fetchData/customerSale/' +route  , 'number','mobile_no',selectedValue = null,readOnly = true);     
      var routeSaleData = localStorage.getItem('routeSaleData');
      var routeSale = JSON.parse(routeSaleData);
      console.log(routeSaleData)
      const cust_name = routeSale.name
      console.log("kfgkdfjk",cust_name)
      await fetchAndPopulateDropdown('http://103.174.102.89:3000/fetchData/customerSale/' +route  , 'grahk','name',selectedValue=cust_name,readOnly = true);
      await fetchAndPopulateDropdown('http://103.174.102.89:3000/routeData', 'Route','route_name',selectedValue=route,readOnly = true);
    }
    
    await fetchAndPopulateDropdown('http://103.174.102.89:3000/purchaseproductData/product', 'product', 'product_name');
    await fetchAndPopulateDropdown('http://103.174.102.89:3000/purchaseproductData/bata', 'bta', 'bata');
    await fetchAndPopulateDropdown('http://103.174.102.89:3000/list/Bank Account', 'onlineAcc', 'name');
  

    
});

async function fetchAndPopulateDropdown(apiUrl, dropdownId, field,selectedValue = null, readOnly = false) {
        try {
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            populateDropdownWithSelect2(data, dropdownId, field,selectedValue, readOnly);
            
        } catch (error) {
            console.error('Error:', error);
        }
    }

  function populateDropdownWithSelect2(data, dropdownId, field,selectedValue = null, readOnly = false) {
    var dropdown = $('#' + dropdownId);
    // Clear existing options
    dropdown.empty();

    // Add placeholder option
    dropdown.append($('<option></option>').attr('value', '').text('Select ' + dropdownId + ' type').prop('disabled', true).prop('selected', true));

    // Populate dropdown with API data
    data.forEach(function (item) {
      dropdown.append($('<option></option>').attr('value', item[field]).text(item[field]));
    });

       // Initialize Select2
       dropdown.select2({
            placeholder: 'Select components',
            closeOnSelect: false,
            allowClear: true,
            templateResult: function (data) {
                if (!data.id) {
                    return data.text;
                }
                var $element = $('<span>' + data.text + '</span>');
                return $element;
            }
        });

        // Set selected value if provided
        if (selectedValue !== null) {
        dropdown.val(selectedValue).trigger('change');
        }

        // Make the dropdown read-only if specified
        if (readOnly) {
            dropdown.prop('disabled', true);
        }

  }



  
</script>


</html>